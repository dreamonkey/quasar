<template>
  <q-header :class="dark? 'bg-white text-black-54':'bg-lp-dark text-white-54'" class="font-monserrat lp-header" ref="layoutHeader">
    <q-toolbar
      :class="{ 'shadow-bottom-small': $q.screen.xs, 'letter-spacing-25': $q.screen.lt.lg, 'letter-spacing-300': $q.screen.gt.md }"
      class="primary-toolbar q-pl-lg q-pr-md justify-between items-stretch"
    >
      <q-btn v-if="$q.screen.xs" flat @click="$emit('update:modelValue', !modelValue)" round dense icon="menu" color="lp-primary"/>
      <div v-if="$q.screen.gt.xs || !isSearchFieldActive" class="row justify-center items-center cursor-pointer" @click="$router.push({name: 'home'})">
        <img v-if="$q.screen.sm" :src="`https://cdn.quasar.dev/logo-v2/svg/logo${!dark? '-dark':''}.svg`" width="48" height="48" alt="Quasar Logo">
        <img v-else :src="`https://cdn.quasar.dev/logo-v2/svg/logo-horizontal${!dark? '-dark':''}.svg`" width="236" :height="$q.screen.xs? '24':'48'" alt="Quasar Logo">
        <q-separator v-if="$q.screen.gt.xs" :color="dark? 'black-12':'lp-primary'" vertical class="q-ml-lg" />
      </div>

      <div class="row items-center text-size-16">
        <div v-if="$q.screen.gt.xs && showNavItems" class="toolbar-menu-items">
          <q-btn
              v-for="(navItem, navItemIndex) in navItems.mainNavItems" :key="navItemIndex"
              :label="navItem.label"
              :to="computeRouteNav(navItem)"
              :href="computeRouteNav(navItem, 'href')"
              :target="navItem.href? '_blank':'_self'"
              :color="setActivePrimaryNavColor($route.path, navItem.path)"
              :padding="`xs ${$q.screen.name}`"
              class="text-weight-bold text-size-16"
              flat
          >
            <q-menu v-if="navItem.subMenu" class="shadow-bottom-small">
              <nav-dropdown-menu :nav-items="navItem.subMenu"/>
            </q-menu>
          </q-btn>
        </div>
        <q-form v-if="isSearchFieldActive" autocapitalize="off" autocomplete="off" spellcheck="false" class="search-form position-relative">
          <q-input ref="searchInputRef" autofocus v-model="searchTerms" :dark="!dark" dense square debounce="300" placeholder="Search Quasar v2..." @keydown="onSearchKeydown" @blur="closeSearchForm" @focus="onSearchFocus">
            <template #append>
              <q-icon v-if="!searchTerms" name="search" size="sm" color="lp-primary" />
              <q-icon v-else name="cancel" @click.stop="resetSearch" class="cursor-pointer"/>
            </template>
          </q-input>
          <div class="search-result-field">
            <q-scroll-area dark class="bg-dark text-white rounded-borders search-result-container">
              <template v-if="searchResults !== null">
                <component v-if="searchResults.masterComponent !== void 0" :is="searchResults.masterComponent"/>
                <app-search-results v-else :results="searchResults" :search-has-focus="searchHasFocus" :search-active-id="searchActiveId"/>
              </template>
            </q-scroll-area>
          </div>
        </q-form>
        <q-btn v-else flat round color="lp-primary" icon="search" size="12px" @click="toggleSearchInputField"/>
      </div>

    </q-toolbar>
    <q-separator :color="dark? 'black-12':'lp-primary'"/>
    <template v-if="$q.screen.gt.xs">
      <q-toolbar :class="!dark? 'add-bottom-glow':''" class="q-pl-none q-pr-md secondary-toolbar letter-spacing-225">
        <q-btn v-if="$q.screen.sm" class="q-pl-sm q-mx-md" flat round dense icon="menu" color="lp-primary" @click="$emit('update:modelValue', !modelValue)"/>
        <q-btn-dropdown no-caps dense auto-close align="left" class="text-weight-bold version-dropdown" :class="$q.screen.gt.sm ? 'q-ml-lg' : ''" padding="sm" outline color="lp-primary">
          <template #label>
            <span :class="dark? 'text-dark':'text-white'" class="text-size-12 letter-spacing-225">{{ `v${$q.version}` }}</span>
            <q-space />
          </template>
          <nav-dropdown-menu :nav-items="versionHistory"/>
        </q-btn-dropdown>
        <template v-if="$q.screen.sm">
          <q-separator :color="dark? 'black-12':'lp-primary'" vertical inset class="q-ml-md q-mr-sm"/>
          <q-btn-dropdown :color="dark? 'text-dark':'text-white'" class="font-monserrat text-weight-bold text-size-12" no-caps dense label="More" flat menu-anchor="bottom right" :menu-offset="[150, 5]">
            <nav-dropdown-menu :nav-items="moreNavItems"/>
          </q-btn-dropdown>
        </template>

        <q-space/>

        <template v-if="$q.screen.gt.sm">
          <!-- We remove "Quasar brand resources" link when on smaller viewports -->
          <q-btn
            v-for="(subNavItem, navIndex) in $q.screen.gt.md ? navItems.subNavItems : navItems.subNavItems.slice(0, -1)"
            :key="`nav-${navIndex}`"
            :label="subNavItem.label"
            :to="computeRouteNav(subNavItem)"
            :href="computeRouteNav(subNavItem, 'href')"
            :target="subNavItem.href? '_blank':'_self'"
            flat
            :color="dark? 'black-54':'white-54'"
            no-caps
            class="text-weight-bold letter-spacing-225 text-size-12"
          >
            <q-menu v-if="subNavItem.subMenu" class="shadow-bottom-small">
              <nav-dropdown-menu :nav-items="subNavItem.subMenu"/>
            </q-menu>
          </q-btn>
        </template>

        <q-btn
          v-for="(socialLink, socialLinkIndex) in socialLinks"
          :key="`social-${socialLinkIndex}`"
          :icon="socialLink.icon"
          :color="dark? 'black-54':'lp-primary'"
          flat
          round padding="sm" size="md"
          type="a" :href="socialLink.href" target="__blank"
        />
      </q-toolbar>
      <q-separator :color="dark? 'black-12':'lp-primary'"/>
    </template>
  </q-header>
</template>
<script>
import { defineComponent, ref } from 'vue'
import { mdiBug, mdiClipboardText, mdiGithub } from '@quasar/extras/mdi-v6'
import { socialLinks } from 'assets/landing-page/social-links.js'
import useSearch from 'layouts/doc-layout/use-search'
import { Screen, useQuasar } from 'quasar'
import { useRoute } from 'vue-router'
import AppSearchResults from 'components/AppSearchResults.vue'
import { navItems } from 'assets/landing-page/nav-items.js'
import { computeRouteNav } from 'assets/landing-page/nav-items.js'
import NavDropdownMenu from 'components/landing-page/NavDropdownMenu'

export default defineComponent({
  name: 'MainLayoutHeader',
  props: {
    modelValue: {
      type: Boolean,
      default: false
    },
    dark: {
      type: Boolean,
      default: false
    }
  },
  components: {
    NavDropdownMenu,
    AppSearchResults
  },
  setup (props) {
    const $q = useQuasar()
    const $route = useRoute()
    const isSearchFieldActive = ref(false)
    const showNavItems = ref(true)

    function toggleSearchInputField () {
      if (isSearchFieldActive.value) {
        showNavItems.value = true
      }
      else showNavItems.value = !Screen.lt.lg

      isSearchFieldActive.value = !isSearchFieldActive.value
    }

    const versionHistory = [
      {
        label: `Latest (v${$q.version})`,
        isHeader: true
      },
      {
        label: 'Release notes',
        icon: mdiClipboardText,
        path: 'start/release-notes'
      },
      {
        label: 'Report a bug',
        icon: mdiBug,
        href: 'https://github.com/quasarframework/quasar/issues'
      },
      {
        label: 'Repository',
        icon: mdiGithub,
        href: 'https://github.com/quasarframework'
      },
      {
        isSeparator: true
      },
      {
        label: 'Older Releases',
        isHeader: true
      },
      {
        label: 'v1 docs',
        href: 'https://v1.quasar.dev/'
      },
      {
        label: 'v0.17 docs',
        href: 'https://v0-17.quasar-framework.org/'
      },
      {
        label: 'v0.16 docs',
        href: 'https://v0-16.quasar-framework.org/'
      },
      {
        label: 'v0.15 docs',
        href: 'https://v0-15.quasar-framework.org/'
      },
      {
        label: 'v0.14 docs',
        href: 'https://v0-14.quasar-framework.org/'
      },
      {
        label: 'v0.13 docs',
        href: 'https://v0-13.quasar-framework.org/'
      }
    ]

    // add components nav item to the 'More' dropdown
    const moreNavItems = [
      {
        label: 'Components',
        path: 'components'
      },
      ...navItems.subNavItems
    ]

    function setActivePrimaryNavColor (routePath, navItemPath) {
      if (routePath === `/${navItemPath}`) {
        return props.dark ? 'lp-primary' : 'white'
      }
    }

    const scope = {
      mdiGithub,
      mdiBug,
      mdiClipboardText,
      navItems,
      socialLinks,
      isSearchFieldActive,
      showNavItems,
      versionHistory,
      moreNavItems,
      computeRouteNav,
      toggleSearchInputField,
      setActivePrimaryNavColor
    }

    useSearch(scope, $q, $route)

    function closeSearchForm () {
      // since the blur event fires before the click event on links in search result form, we need to wait a bit
      // before hiding the search form, else the search form will be hidden before the click event is fired
      setTimeout(() => {
        scope.onSearchBlur()
        scope.resetSearch()
        toggleSearchInputField()
      }, 100)
    }

    return { ...scope, closeSearchForm }
  }
})
</script>
<style lang="scss" scoped>
$footer-columns-md-min: 6;
$footer-columns-sm-min: 4;
$adjust-header-viewport: 860px;
$search-form-width: 300px;

// remove second child, (components nav)
.toolbar-menu-items {
  .q-btn:nth-child(2) {
    @media screen and (max-width: $adjust-header-viewport) {
      display: none;
    }
  }
}

.primary-toolbar {
  height: 92px;
}

.secondary-toolbar {
  height: 62px;
}

.version-dropdown {
  width: 220px;
}

.search-form {
  width: $search-form-width;
}

.search-result-field {
  position: absolute;
  left: 0;
  z-index: 10000;
  width: $search-form-width;
}

.search-result-container {
  height: 80vh;
  max-width: $search-form-width;
}

.lp-header {
  transition: all .3s ease-in-out;
}

.add-bottom-glow {
  transition: all .5s;
  animation: bottom-glow 1.5s ease-in-out infinite alternate;
}

@keyframes bottom-glow {
  0% {
    box-shadow: 0 6px 6px 0 rgba($lp-primary, 0.48);
  }
  to {
    box-shadow: 0 4.5px 4.5px 0 rgba($lp-primary, 0.28);
  }
}
</style>
